# 测试计划 - HTTP 服务器绑定配置

## 测试环境准备

```bash
# 1. 确保后端依赖已安装
cd backend
pip install -r requirements.txt

# 2. 确保前端依赖已安装
cd frontend
npm install

# 3. 构建前端（生产模式测试）
npm run build
```

---

## 测试用例

### TC-5.1: 测试默认绑定地址为 127.0.0.1

**前置条件**: 删除现有配置文件

```bash
rm backend/config.yaml
```

**测试步骤**:
1. 启动后端服务: `cd backend && python main.py`
2. 观察启动日志

**预期结果**:
- 日志显示: `Starting server on 127.0.0.1:8000`
- 服务只能在 localhost 访问
- 外部设备无法访问 `http://<server-ip>:8000`

**验证命令**:
```bash
# 本地应该可以访问
curl http://127.0.0.1:8000/api/status
# 返回: {"status":"running"}

# 从其他设备尝试访问应该失败
curl http://<server-ip>:8000/api/status
# 连接超时或拒绝
```

---

### TC-5.2: 测试自定义绑定地址配置

**测试步骤**:
1. 访问前端页面: `http://localhost:5173` (开发模式)
2. 点击左侧「系统」菜单
3. 选择「允许所有网络接口 (0.0.0.0)」
4. 点击「保存配置」
5. 重启后端服务

**预期结果**:
- 保存成功后显示重启提示
- 配置文件 `backend/config.yaml` 包含:
  ```yaml
  server:
    bind_address: "0.0.0.0"
    port: 8000
  ```
- 重启后外部设备可以访问

**验证命令**:
```bash
# 从其他设备
curl http://<server-ip>:8000/api/status
# 返回: {"status":"running"}
```

---

### TC-5.3: 测试无效 IP 地址验证

**测试步骤**:
1. 访问「系统」配置页面
2. 选择「自定义 IP 地址」
3. 输入无效 IP: `999.999.999.999`
4. 观察验证提示

**预期结果**:
- 输入框边框变红
- 显示错误提示: "请输入有效的 IP 地址"
- 保存按钮禁用

**后端验证**:
```bash
curl -X POST http://localhost:8000/api/system/config \
  -H "Content-Type: application/json" \
  -d '{"bind_address":"invalid-ip","port":8000}'
# 返回 422 错误
```

---

### TC-5.4: 测试配置文件创建

**测试步骤**:
1. 停止后端服务
2. 删除配置文件: `rm backend/config.yaml`
3. 重新启动后端

**预期结果**:
- 服务正常启动（使用默认配置）
- 访问 `GET /api/system/config` 返回:
  ```json
  {
    "bind_address": "127.0.0.1",
    "port": 8000,
    "restart_required": false,
    "message": "Current server configuration"
  }
  ```

---

### TC-5.5: 测试系统设置页面 UI 交互

**测试步骤**:
1. 访问前端「系统」页面
2. 验证以下元素存在:
   - [ ] 页面标题 "系统配置"
   - [ ] 三个单选选项（localhost/all/custom）
   - [ ] 端口输入框
   - [ ] 保存按钮
   - [ ] 当前配置显示区域
3. 测试选项切换:
   - 点击「仅本地访问」→ 单选选中，自定义输入框禁用
   - 点击「允许所有网络接口」→ 单选选中
   - 点击「自定义 IP 地址」→ 显示输入框，可输入 IP
4. 测试保存流程:
   - 选择「允许所有网络接口」
   - 点击保存
   - 验证显示「需要重启服务」提示

**预期结果**:
- 所有 UI 元素正常显示
- 选项切换正常
- 保存后显示重启提示

---

## 回归测试

### 现有功能不受影响

- [ ] LLM 配置页面正常工作
- [ ] ASR/TTS 配置正常
- [ ] Live2D 渲染正常
- [ ] 记忆功能正常
- [ ] WebSocket 连接正常

---

## 测试结果记录

| 测试项 | 状态 | 测试人 | 日期 | 备注 |
|--------|------|--------|------|------|
| TC-5.1 默认绑定地址 | ⬜ 待测试 | - | - | - |
| TC-5.2 自定义绑定地址 | ⬜ 待测试 | - | - | - |
| TC-5.3 无效 IP 验证 | ⬜ 待测试 | - | - | - |
| TC-5.4 配置文件创建 | ⬜ 待测试 | - | - | - |
| TC-5.5 UI 交互测试 | ⬜ 待测试 | - | - | - |

---

## 已知限制

1. **任务 3.4 认证/授权**: 当前 API 端点没有额外的认证，假设在受信任的内网环境使用
2. **配置热更新**: 修改配置后需要重启服务才能生效（设计决策）
3. **IPv6 支持**: 已支持，但主要测试基于 IPv4

---

## 测试通过标准

- [ ] 所有测试用例通过
- [ ] 默认行为符合安全预期（仅本地访问）
- [ ] 配置修改流程顺畅
- [ ] 现有功能无回归
